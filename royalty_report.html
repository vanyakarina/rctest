<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royalty Report</title>
    <style>
        nav {
            background-color: #333;
            padding: 10px;
            color: white;
            text-align: center;
        }
        nav a {
            color: white;
            text-decoration: none;
            padding: 14px 20px;
            display: inline-block;
        }
        nav a:hover {
            background-color: #575757;
        }
        .content {
            margin: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
        }
        table, th, td {
            border: 1px solid black;
        }
        th, td {
            padding: 8px;
            text-align: left;
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="catalogue_input.html">Catalogue Registration</a>
        <a href="catalogue_list.html">Works</a>
        <a href="songwriters.html">Songwriters</a>
        <a href="royalty_calculator.html">Royalty Calculator</a>
        <a href="royalty_report.html">Royalty Report</a>
    </nav>

    <div class="content">
        <h1>Royalty Report</h1>
        <form id="royaltyForm">
            <h2>Select Period</h2>
            <label for="periodSelect">Period:</label>
            <select id="periodSelect" required>
                <option value="">Select a period</option>
                <option value="2019-01-06">Jan-Jun 19</option>
                <option value="2019-07-12">Jul-Dec 19</option>
                <option value="2020-01-06">Jan-Jun 20</option>
                <option value="2020-07-12">Jul-Dec 20</option>
                <!-- Add more periods up to 2040 -->
                <option value="2040-01-06">Jan-Jun 40</option>
                <option value="2040-07-12">Jul-Dec 40</option>
            </select>
            <br><br>
            <h2>Input Royalties</h2>
            <table id="inputTable">
                <thead>
                    <tr>
                        <th>Song Title</th>
                        <th>Digital Royalty</th>
                        <th>Synch Royalty</th>
                        <th>Mechanical Royalty</th>
                        <th>Performance Royalty</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Input rows will be filled by JavaScript -->
                </tbody>
            </table>
            <br>
            <button type="button" onclick="calculateAllRoyalties()">Calculate All Royalties</button>
            <br><br>
        </form>

        <h2>Royalty Breakdown</h2>
        <table id="royaltyTable">
            <thead>
                <tr>
                    <th>Song Title</th>
                    <th>Songwriter</th>
                    <th>Status</th>
                    <th>Digital Royalty</th>
                    <th>Synch Royalty</th>
                    <th>Mechanical Royalty</th>
                    <th>Performance Royalty</th>
                    <th>Total Royalty</th>
                </tr>
            </thead>
            <tbody>
                <!-- Royalty data will be added here -->
            </tbody>
        </table>

        <h2>Filter by Songwriter</h2>
        <label for="filterSongwriter">Select Songwriter:</label>
        <select id="filterSongwriter">
            <option value="">Select a songwriter</option>
            <!-- Options will be filled by JavaScript -->
        </select>
        <button type="button" onclick="filterBySongwriter()">Filter</button>
        <br><br>

        <h2>Total Royalties by Songwriter</h2>
        <table id="filteredRoyaltyTable">
            <thead>
                <tr>
                    <th>Songwriter</th>
                    <th>Total Digital Royalty</th>
                    <th>Total Synch Royalty</th>
                    <th>Total Mechanical Royalty</th>
                    <th>Total Performance Royalty</th>
                    <th>Total Royalty</th>
                </tr>
            </thead>
            <tbody>
                <!-- Filtered royalty data will be added here -->
            </tbody>
        </table>

        <br>
        <button onclick="exportData()">Export Data</button>
        <input type="file" id="importFile" />
        <button onclick="importData()">Import Data</button>
    </div>

    <script>
        let catalogue = JSON.parse(localStorage.getItem('catalogue')) || [];
        let songwriters = JSON.parse(localStorage.getItem('songwriters')) || [];
        let royalties = [];

        function populateSongTitles() {
            const inputTableBody = document.getElementById('inputTable').getElementsByTagName('tbody')[0];
            catalogue.forEach(song => {
                const row = inputTableBody.insertRow();
                row.insertCell(0).textContent = song.title;
                row.insertCell(1).innerHTML = `<input type="number" data-song="${song.title}" class="digitalRoyalty" placeholder="Digital Royalty">`;
                row.insertCell(2).innerHTML = `<input type="number" data-song="${song.title}" class="synchRoyalty" placeholder="Synch Royalty">`;
                row.insertCell(3).innerHTML = `<input type="number" data-song="${song.title}" class="mechanicalRoyalty" placeholder="Mechanical Royalty">`;
                row.insertCell(4).innerHTML = `<input type="number" data-song="${song.title}" class="performanceRoyalty" placeholder="Performance Royalty">`;
            });
        }

        function calculateAllRoyalties() {
            const inputRows = document.querySelectorAll('#inputTable tbody tr');
            let totalRoyalties = [];

            inputRows.forEach(row => {
                const songTitle = row.cells[0].textContent;
                const digitalRoyalty = parseFloat(row.querySelector('.digitalRoyalty').value) || 0;
                const synchRoyalty = parseFloat(row.querySelector('.synchRoyalty').value) || 0;
                const mechanicalRoyalty = parseFloat(row.querySelector('.mechanicalRoyalty').value) || 0;
                const performanceRoyalty = parseFloat(row.querySelector('.performanceRoyalty').value) || 0;

                const song = catalogue.find(s => s.title === songTitle);
                if (song) {
                    let songData = song.songwriters.map(sw => {
                        const songwriter = songwriters.find(s => s.name === sw.name);
                        const isSigned = songwriter && songwriter.signed;
                        let royalties = {
                            name: sw.name,
                            songTitle: songTitle,
                            status: isSigned ? 'Signed' : 'Unsigned',
                            digital: 0,
                            synch: 0,
                            mechanical: 0,
                            performance: 0,
                            total: 0
                        };

                        if (isSigned) {
                            const totalShare = song.songwriters.reduce((sum, s) => sum + (s.share || 0), 0);
                            royalties.digital = (sw.share / totalShare) * digitalRoyalty;
                            royalties.synch = (sw.share / totalShare) * synchRoyalty;
                            royalties.mechanical = (sw.share / totalShare) * mechanicalRoyalty;
                            royalties.performance = (sw.share / totalShare) * performanceRoyalty;
                            royalties.total = royalties.digital + royalties.synch + royalties.mechanical + royalties.performance;
                        }

                        return royalties;
                    });

                    songData.forEach(data => {
                        if (data.status === 'Signed') {
                            totalRoyalties.push(data);
                        }
                    });
                }
            });

            updateRoyaltyTable(totalRoyalties);
            updateFilteredRoyaltyTable(totalRoyalties);
        }

        function updateRoyaltyTable(royaltyData) {
            const tableBody = document.getElementById('royaltyTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            royaltyData.forEach(data => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = data.songTitle;
                row.insertCell(1).textContent = data.name;
                row.insertCell(2).textContent = data.status;
                row.insertCell(3).textContent = data.digital.toFixed(2);
                row.insertCell(4).textContent = data.synch.toFixed(2);
                row.insertCell(5).textContent = data.mechanical.toFixed(2);
                row.insertCell(6).textContent = data.performance.toFixed(2);
                row.insertCell(7).textContent = data.total.toFixed(2);
            });
        }

        function updateFilteredRoyaltyTable(royaltyData) {
            const filterSongwriter = document.getElementById('filterSongwriter').value;
            let filteredData = royaltyData;

            if (filterSongwriter) {
                filteredData = royaltyData.filter(data => data.name === filterSongwriter);
            }

            const songwriterTotals = filteredData.reduce((totals, data) => {
                if (!totals[data.name]) {
                    totals[data.name] = { digital: 0, synch: 0, mechanical: 0, performance: 0, total: 0 };
                }
                totals[data.name].digital += data.digital;
                totals[data.name].synch += data.synch;
                totals[data.name].mechanical += data.mechanical;
                totals[data.name].performance += data.performance;
                totals[data.name].total += data.total;
                return totals;
            }, {});

            const tableBody = document.getElementById('filteredRoyaltyTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';
            Object.keys(songwriterTotals).forEach(name => {
                const data = songwriterTotals[name];
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = name;
                row.insertCell(1).textContent = data.digital.toFixed(2);
                row.insertCell(2).textContent = data.synch.toFixed(2);
                row.insertCell(3).textContent = data.mechanical.toFixed(2);
                row.insertCell(4).textContent = data.performance.toFixed(2);
                row.insertCell(5).textContent = data.total.toFixed(2);
            });
        }

        function filterBySongwriter() {
            updateFilteredRoyaltyTable(royalties);
        }

        function exportData() {
            const data = JSON.stringify(royalties);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'royalties.json';
            a.click();
            URL.revokeObjectURL(url);
        }

        function importData() {
            const fileInput = document.getElementById('importFile');
            if (fileInput.files.length === 0) return;

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = function(e) {
                const data = JSON.parse(e.target.result);
                catalogue = data.catalogue || catalogue;
                songwriters = data.songwriters || songwriters;
                royalties = data.royalties || royalties;
                localStorage.setItem('catalogue', JSON.stringify(catalogue));
                localStorage.setItem('songwriters', JSON.stringify(songwriters));
                localStorage.setItem('royalties', JSON.stringify(royalties));
                populateSongTitles();
            };
            reader.readAsText(file);
        }

        window.onload = function() {
            populateSongTitles();
            // Populate filter dropdown
            const filterSelect = document.getElementById('filterSongwriter');
            songwriters.forEach(sw => {
                if (sw.signed) {
                    const option = document.createElement('option');
                    option.value = sw.name;
                    option.textContent = sw.name;
                    filterSelect.appendChild(option);
                }
            });
        };
    </script>
</body>
</html>

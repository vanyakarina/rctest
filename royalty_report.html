<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Royalty Report</title>
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <style>
        nav { /* your styles for navigation */ }
        .content { /* your styles for content */ }
        table { /* your styles for table */ }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Home</a>
        <a href="songwriters.html">Songwriters Input</a>
        <a href="catalogue.html">Catalogue Input</a>
        <a href="royalty.html">Royalty Calculation</a>
        <a href="royalty_report.html">Royalty Report</a>
    </nav>

    <div class="content">
        <h1>Royalty Report</h1>
        <form id="royaltyReportForm">
            <label for="period">Royalty Period:</label>
            <select id="period">
                <!-- Populate options dynamically -->
            </select>
            <h2>Input Royalties</h2>
            <table id="royaltyTable">
                <thead>
                    <tr>
                        <th>Song Title</th>
                        <th>Total Digital Royalty</th>
                        <th>Total Synch Royalty</th>
                        <th>Total Mechanical Royalty</th>
                        <th>Total Performance Royalty</th>
                        <th>Total Royalty</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Songs will be added here -->
                </tbody>
            </table>
            <button type="button" onclick="calculateRoyalties()">Calculate Royalties</button>
        </form>

        <h2>Royalty Report</h2>
        <table id="royaltyReportTable">
            <thead>
                <tr>
                    <th>Song Title</th>
                    <th>Songwriter</th>
                    <th>Royalty Amount</th>
                </tr>
            </thead>
            <tbody>
                <!-- Royalty calculations will be added here -->
            </tbody>
        </table>
    </div>

    <script>
        let catalogue = JSON.parse(localStorage.getItem('catalogue')) || [];
        let songwriters = JSON.parse(localStorage.getItem('songwriters')) || [];
        let royalties = {}; // Will hold the calculated royalties

        function populatePeriodOptions() {
            const periods = [
                'Jan-Jun 2020', 'Jul-Dec 2020', 'Jan-Jun 2021', 'Jul-Dec 2021',
                'Jan-Jun 2022', 'Jul-Dec 2022', 'Jan-Jun 2023', 'Jul-Dec 2023',
                'Jan-Jun 2024', 'Jul-Dec 2024', 'Jan-Jun 2025', 'Jul-Dec 2025',
                'Jan-Jun 2026', 'Jul-Dec 2026', 'Jan-Jun 2027', 'Jul-Dec 2027',
                'Jan-Jun 2028', 'Jul-Dec 2028', 'Jan-Jun 2029', 'Jul-Dec 2029',
                'Jan-Jun 2030', 'Jul-Dec 2030'
            ];
            const periodSelect = document.getElementById('period');
            periods.forEach(period => {
                const option = document.createElement('option');
                option.value = period;
                option.textContent = period;
                periodSelect.appendChild(option);
            });
        }

        function renderCatalogueForReport() {
            const tableBody = document.getElementById('royaltyTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = '';

            catalogue.forEach(song => {
                const row = tableBody.insertRow();
                row.insertCell(0).textContent = song.title;

                const digitalRoyaltyInput = document.createElement('input');
                digitalRoyaltyInput.type = 'number';
                digitalRoyaltyInput.id = `digital_${song.title}`;
                digitalRoyaltyInput.oninput = updateTotalRoyalty;
                row.insertCell(1).appendChild(digitalRoyaltyInput);

                const synchRoyaltyInput = document.createElement('input');
                synchRoyaltyInput.type = 'number';
                synchRoyaltyInput.id = `synch_${song.title}`;
                synchRoyaltyInput.oninput = updateTotalRoyalty;
                row.insertCell(2).appendChild(synchRoyaltyInput);

                const mechanicalRoyaltyInput = document.createElement('input');
                mechanicalRoyaltyInput.type = 'number';
                mechanicalRoyaltyInput.id = `mechanical_${song.title}`;
                mechanicalRoyaltyInput.oninput = updateTotalRoyalty;
                row.insertCell(3).appendChild(mechanicalRoyaltyInput);

                const performanceRoyaltyInput = document.createElement('input');
                performanceRoyaltyInput.type = 'number';
                performanceRoyaltyInput.id = `performance_${song.title}`;
                performanceRoyaltyInput.oninput = updateTotalRoyalty;
                row.insertCell(4).appendChild(performanceRoyaltyInput);

                const totalRoyaltyInput = document.createElement('input');
                totalRoyaltyInput.type = 'number';
                totalRoyaltyInput.id = `total_${song.title}`;
                totalRoyaltyInput.readOnly = true;
                row.insertCell(5).appendChild(totalRoyaltyInput);
            });
        }

        function updateTotalRoyalty() {
            catalogue.forEach(song => {
                const digitalRoyalty = parseFloat(document.getElementById(`digital_${song.title}`).value) || 0;
                const synchRoyalty = parseFloat(document.getElementById(`synch_${song.title}`).value) || 0;
                const mechanicalRoyalty = parseFloat(document.getElementById(`mechanical_${song.title}`).value) || 0;
                const performanceRoyalty = parseFloat(document.getElementById(`performance_${song.title}`).value) || 0;

                const totalRoyalty = digitalRoyalty + synchRoyalty + mechanicalRoyalty + performanceRoyalty;
                document.getElementById(`total_${song.title}`).value = totalRoyalty.toFixed(2);
            });
        }

        function calculateRoyalties() {
            const period = document.getElementById('period').value;
            if (!period) {
                alert('Please select a period.');
                return;
            }

            const reportTableBody = document.getElementById('royaltyReportTable').getElementsByTagName('tbody')[0];
            reportTableBody.innerHTML = '';

            songwriters.forEach(sw => {
                let totalRoyaltyForSongwriter = 0;

                catalogue.forEach(song => {
                    const digitalRoyalty = parseFloat(document.getElementById(`digital_${song.title}`).value) || 0;
                    const synchRoyalty = parseFloat(document.getElementById(`synch_${song.title}`).value) || 0;
                    const mechanicalRoyalty = parseFloat(document.getElementById(`mechanical_${song.title}`).value) || 0;
                    const performanceRoyalty = parseFloat(document.getElementById(`performance_${song.title}`).value) || 0;

                    const totalRoyalty = digitalRoyalty + synchRoyalty + mechanicalRoyalty + performanceRoyalty;
                    const totalShare = songwriters.reduce((sum, songwriter) => {
                        if (songwriter.isSigned) {
                            return sum + (songwriter.shares[song.title] || 0);
                        }
                        return sum;
                    }, 0);

                    if (totalShare > 0) {
                        const royalty = totalRoyalty * (sw.shares[song.title] || 0) / totalShare;
                        totalRoyaltyForSongwriter += royalty;

                        const row = reportTableBody.insertRow();
                        row.insertCell(0).textContent = song.title;
                        row.insertCell(1).textContent = sw.name;
                        row.insertCell(2).textContent = royalty.toFixed(2);
                    }
                });

                // Optional: Show total royalty for the songwriter
                if (totalRoyaltyForSongwriter > 0) {
                    const row = reportTableBody.insertRow();
                    row.insertCell(0).textContent = 'Total';
                    row.insertCell(1).textContent = sw.name;
                    row.insertCell(2).textContent = totalRoyaltyForSongwriter.toFixed(2);
                }
            });

            alert('Royalty calculation completed!');
        }

        // Initialize the page
        populatePeriodOptions();
        renderCatalogueForReport();
    </script>
</body>
</html>
